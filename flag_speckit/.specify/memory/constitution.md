# Feature Flag 프로젝트 헌법

## Core Principles

### I. 안전 우선 (Safety-First)
모든 기능 플래그는 기본값이 안전해야 한다. 즉, 장애가 발생하거나 롤백이 필요할 때 사용자에게 영향을 최소화하도록 "비활성화(오프)" 상태를 기본으로 한다. 치명적 결함 시 즉시 전체 비활성화(kill-switch)가 가능해야 한다.

- 기본 동작: flag = off
- 긴급 대응: 중앙의 kill-switch 및 관리용 API/콘솔 제공
- 실패 격리: 플래그 평가는 빠르고 부작용이 없어야 함

### II. 일관성 있는 평가 (Deterministic & Low-latency)
플래그 평가 결과는 동일한 입력(요청, 워크스페이스 id 등)에 대해 예측 가능해야 한다.

- 결정성: 동일한 세그멘테이션 로직과 시드(seed)를 사용하면 동일한 결과 보장
- 레이턴시: 평가 경로는 핫패스에 적합하도록 경량화(평균 1ms 이하 권장)
- 캐싱: 일관된 TTL과 무효화 전략을 문서화

### III. 규칙 기반 타게팅과 점진적 롤아웃 (Rollout)
플래그는 다양한 타게팅 옵션(명시적 목록, 사용자/워크스페이스 속성, 세그먼트, 퍼센트 롤아웃)을 지원해야 한다.

- 퍼센트 롤아웃은 해시 기반으로 결정성 있는 분배를 사용
- 타게팅 규칙은 우선순위와 충돌 해소 규칙을 명확히 함
- 실험(AB) 목적의 이벤트 태깅 및 메트릭 연동 지원

### IV. 관찰성 (Observability) 및 감사 (Audit)
플래그 변경과 평가에 대한 로그, 메트릭, 감사기록을 남겨야 한다.

- 평가 로그: 샘플링 수준과 민감도 규칙 정의
- 메트릭: 평가 성공률, 활성화 비율, 영향분석 지표(에러율, 응답시간)
- 감사: 플래그 생성/수정/삭제/롤백에 대한 변경자와 타임스탬프 기록

### V. 테스트 우선 (Test-First) 및 자동화
플래그 관련 기능은 단위/통합/엔드투엔드 테스트가 자동으로 있어야 한다.

- 테스트 범위: 평가 로직, 타게팅 규칙, 퍼센트 분배, 실패/타임아웃 시 폴백
- CI: 모든 PR은 테스트 통과·정적분석 통과가 조건

### VI. 보안과 개인정보보호 (Privacy & Security)
플래그 데이터와 타게팅에 사용되는 워크스페이스/사용자 속성은 개인정보 규정을 준수해야 한다.

- 최소 원칙: 필요한 최소 데이터만 사용
- 암호화: 저장/전송 시 민감 정보 암호화
- 접근 제어: 플래그 관리/조회 API에 권한 기반 접근 제어 필요

### VII. 버전관리와 호환성 (Versioning & Backwards Compatibility)
플래그의 스키마 및 평가 계약은 명시적 버전관리 규칙을 가져야 한다.

- 권장 형식: MAJOR.MINOR.PATCH
- 깨지는 변경(Breaking change)은 명시적 공지와 마이그레이션 계획 필요

---

## 구체적 요구사항 (Functional Requirements)
아래 항목들은 사용자가 제시한 요구사항을 문서화한 것입니다.

### 피쳐 플래깅
1. 전체 기능에 대한 on / off 가능
   - 전역 스위치(예: kill-switch)로 전체 기능을 즉시 비활성화할 수 있어야 함.
2. 일부 기능에 대한 on / off 가능
   - 기능(Feature) 단위로 토글을 지원하여 특정 기능만 활성/비활성화 가능.

### A/B 테스트 / 점진적 릴리즈
1. 그룹 단위 릴리즈
   - 특정 워크스페이스 묶음(명시적 포함/제외 리스트), 특정 비율(%) 또는 특정 숫자(N) 기준으로 그룹화하여 기능별로 릴리즈할 수 있어야 함.
   - 그룹 할당은 결정적(Deterministic)이어야 하며, seed/버전 기반 해시 방식을 사용하여 동일한 워크스페이스가 반복적으로 동일한 그룹에 속하도록 보장해야 함.

1-a. 릴리즈된 대상의 지속성
   - 한 번 릴리즈된 워크스페이스는 별도 오프로 설정되지 않는 한 해당 기능을 계속 제공해야 한다(멤버십이 안정적이어야 함).

1-b. 샘플 안정성
   - 워크스페이스 수가 증가하더라도 기존 10% 샘플에서 대상이 제외되지 않도록 설계해야 함(예: id 기반 해시 또는 consistent hashing 사용).

2. 클라이언트 가시성
   - 클라이언트(프론트엔드)는 현재 조회 중인 워크스페이스에 어떤 피쳐 플래그가 적용되는지 확인할 수 있어야 하며, 이를 위해 워크스페이스 조회 응답 또는 별도 flags API에 평가 결과를 포함할 수 있어야 함.

3. 서버 가시성
   - 서버는 요청 처리 시 현재 처리 중인 워크스페이스에 어떤 피쳐 플래그가 적용되는지 평가하고 이용할 수 있어야 함(서버 SDK/라이브러리로 workspace_id 기준 평가).

4. 다중 플래그 적용
   - 하나의 워크스페이스에 여러 피쳐 플래그가 동시에 적용될 수 있어야 하며, 우선순위 및 충돌 해결 규칙을 정의해야 함.

5. 성능 및 확장성
   - 워크스페이스 수가 만(1e4), 백만(1e6) 단위로 증가하더라도 개별 평가의 평균 지연 및 처리량을 유지해야 함.
   - 평가 비용은 전체 워크스페이스 수에 선형적으로 증가하면 안 되며, 평가 시 가능한 한 O(1)에 가까운 상수 시간으로 작동하도록 설계해야 함.

---

## 설계·운영 고려사항 (Implementation Notes)
- 결정적 퍼센트 롤아웃 예시
  - 입력: workspace_id, flag_id, seed
  - 알고리즘: hash = SHA256(seed + ":" + workspace_id + ":" + flag_id)
    - value = (first 8 bytes of hash as unsigned) % 10000  // 0..9999
    - threshold = desired_percent * 100
    - 활성 조건: value < threshold
  - 장점: 결정적이며 워크스페이스 인구 변화에 따른 멤버십 변동 최소화

- 안정적 멤버십
  - 해시 기반 배정 또는 consistent hashing을 통해 멤버십 안정성을 보장
  - allow/deny와 같은 명시적 목록은 해시 기반 규칙보다 우선 적용

- 그룹/세그먼트 지정 방식
  - 명시적 목록(allow/deny)
  - 속성 기반 세그먼트(예: plan=tier, region)
  - 해시 기반 비율(%)
  - 세 가지 방식을 조합할 수 있어야 함

- 우선순위/충돌 해결(권장)
  1. Allow list (명시적 포함)
  2. Deny list (명시적 제외)
  3. 명시적 속성 기반 타게팅
  4. 퍼센트/해시 기반 롤아웃

- 클라이언트/서버 노출
  - 권장: 워크스페이스 조회 응답에 `featureFlags` 필드 포함
  - 선택: 전용 엔드포인트 `GET /flags?workspace_id={id}` 제공
  - 주의: flags 응답에 민감 정보 포함 금지, 권한 검증 필요

- 캐시 및 동기화
  - L1: 인스턴스 로컬 메모리 캐시(짧은 TTL)
  - L2: 중앙 캐시(Redis)로 여러 인스턴스 간 공유
  - 변경 시: Pub/Sub 또는 이벤트(예: Redis Pub/Sub, Kafka)로 무효화/갱신 전파

- 대용량 목록(allow/deny/세그먼트) 처리
  - 매우 큰 명시적 목록은 Redis set, Bloom filter, 또는 별도 세그먼트 서비스로 관리

- 성능 보호
  - 평가 경로는 핫패스에 적합하게 경량화(해시 연산 + 룰 검사)
  - 대량 요청 대비 슬로팅/레이트 리미트 및 회로 차단 전략 준비

- 관찰성
  - 평가 메트릭: 평가 레이턴시, 활성화 비율, 캐시 히트율
  - 감사 로그: 플래그 생성/수정/삭제 기록(사용자, 시간, 이전/새값)

- 테스트
  - 멤버십 안정성 테스트(반복성)
  - 퍼센트 정확도(통계적 검증)
  - 성능 테스트(1e4~1e6 워크스페이스 시나리오)

---

## 추가 제약 (Operational Constraints)
- 지원 플랫폼: 현재 JVM 기반 서비스 우선 지원. REST API 및 SDK(필요 시) 제공
- 가용성 목표: 평가 API 99.95% 이상 권장
- 일관성 모델: 최종적 일관성(비동기 동기화) 기본, 필요 시 강일관성 옵션 문서화
- 저장소: 플래그 메타데이터는 중앙 저장소(예: DB, Git-backed)와 로컬/분산 캐시(Redis 등) 조합 권장
- 재해 복구: 구성의 버전이력과 빠른 롤백 경로 확보

## 개발 워크플로우 및 품질 게이트
- 이슈 → RFC(중요 변경 시) → PR
- PR 요구사항:
  - 최소 1명의 리뷰어 승인
  - 관련 단위/통합 테스트 포함
  - 변경이 관찰성/보안/성능에 영향이 있으면 체크리스트 첨부
- CI 파이프라인:
  - 정적분석(린트), 테스트, 빌드, 문서 생성
  - 성능 회귀(중요 변경 시 간이 벤치마크)
- 배포 전략:
  - 단계적 롤아웃(개발→스테이징→프로덕션), 캔리 배포 권장
  - 메이저 변경 시 소규모 트래픽에서 검증 후 확대

## 거버넌스
- 이 문서는 기본 규칙을 정의한다. 예외는 RFC로 문서화하고 승인을 받아야 한다.
- 소유자: `feature-flag-core` 팀(또는 지정된 담당자)은 주요 변경을 심사·승인한다.
- 수정 절차:
  1. 변경 제안(RFC) 제출
  2. 기술 리뷰 및 영향 분석
  3. 승인 및 마이그레이션 계획 수립
  4. 문서화 및 배포
- 규정 준수 검증: 모든 PR은 헌법 체크리스트(안전, 테스트, 관찰성, 보안)를 통과해야 한다.

**Version**: 1.1.0 | **Ratified**: 2025-10-24 | **Last Amended**: 2025-10-24

